---
/**
 * CapacityBanner.astro
 * 
 * Banner dinamico che mostra le date con capacit√† esaurita.
 * Legge i dati dal foglio "ControlloCapacita" di Google Sheets via CSV.
 * 
 * Props:
 * - tipo: "prenotazioni" | "asporto" | "entrambi" (default: "entrambi")
 * - sheetId: ID del Google Sheet (opzionale, usa env var di default)
 * - gid: GID del foglio ControlloCapacita (default: da configurazione)
 * 
 * Il banner appare SOLO se ci sono date:
 * - Con stato "üî¥ FULL"
 * - Con Gestito = FALSE (o vuoto)
 * - Con data >= oggi
 */

interface Props {
  tipo?: 'prenotazioni' | 'asporto' | 'entrambi';
  sheetId?: string;
  gid?: string;
}

const { 
  tipo = 'entrambi',
  sheetId = import.meta.env.PUBLIC_GOOGLE_SHEET_ID || '1JoSO08H7IETrwrwe3baIDcWnp_QEMQQV0z2p31ZbVjQ',
  gid = import.meta.env.PUBLIC_CONTROLLO_CAPACITA_GID || '0' // Da aggiornare con il GID corretto
} = Astro.props;

// Costruisci URL del CSV pubblicato
// NOTA: Il foglio deve essere pubblicato come CSV
// File ‚Üí Condividi ‚Üí Pubblica sul Web ‚Üí Foglio "ControlloCapacita" ‚Üí CSV
const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&gid=${gid}`;

// Interfaccia per i dati di capacit√†
interface CapacityData {
  data: string;
  giorno: string;
  tipo: string;
  soglia: number;
  attuale: number;
  stato: string;
  gestito: boolean;
}

// Funzione per parsare il CSV
function parseCSV(csv: string): CapacityData[] {
  const lines = csv.split('\n').filter(line => line.trim());
  if (lines.length <= 1) return [];
  
  const results: CapacityData[] = [];
  
  // Salta header (prima riga)
  for (let i = 1; i < lines.length; i++) {
    const line = lines[i];
    // Parse CSV considerando le virgolette
    const values = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
    const cleanValues = values.map(v => v.replace(/^"|"$/g, '').trim());
    
    if (cleanValues.length >= 8) {
      results.push({
        data: cleanValues[0],        // A: Data
        giorno: cleanValues[1],      // B: Giorno
        tipo: cleanValues[2],        // C: Tipo
        soglia: parseInt(cleanValues[3]) || 0,  // D: Soglia
        attuale: parseInt(cleanValues[4]) || 0, // E: Attuale
        stato: cleanValues[6],       // G: Stato
        gestito: cleanValues[7]?.toUpperCase() === 'TRUE' || cleanValues[7] === '‚úÖ'
      });
    }
  }
  
  return results;
}

// Funzione per verificare se una data √® >= oggi
function isDateValid(dateStr: string): boolean {
  if (!dateStr) return false;
  
  // Parse date in formato dd/MM/yyyy
  const parts = dateStr.split('/');
  if (parts.length !== 3) return false;
  
  const date = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  return date >= today;
}

// Filtra i dati per il tipo richiesto
function filterByTipo(data: CapacityData[], tipoFilter: string): CapacityData[] {
  return data.filter(item => {
    // Solo date non gestite con stato FULL e data valida
    if (item.gestito || item.stato !== 'üî¥ FULL' || !isDateValid(item.data)) {
      return false;
    }
    
    // Filtra per tipo
    if (tipoFilter === 'entrambi') return true;
    if (tipoFilter === 'prenotazioni' && item.tipo === 'Prenotazioni') return true;
    if (tipoFilter === 'asporto' && item.tipo === 'Asporto') return true;
    
    return false;
  });
}

// Fetch dati (avviene al build time, ma il client pu√≤ aggiornare)
let capacityAlerts: CapacityData[] = [];
let fetchError = false;

try {
  // Al build time, prova a fetchare i dati
  // In produzione, il client aggiorner√† con JavaScript
  const response = await fetch(csvUrl);
  if (response.ok) {
    const csvText = await response.text();
    const allData = parseCSV(csvText);
    capacityAlerts = filterByTipo(allData, tipo);
  }
} catch (error) {
  console.error('Errore fetch ControlloCapacita:', error);
  fetchError = true;
}

// Determina il messaggio in base al tipo
const tipoLabel = tipo === 'prenotazioni' ? 'Prenotazioni tavoli' : 
                  tipo === 'asporto' ? 'Ordini d\'asporto' : 
                  'Prenotazioni';
---

<!-- Banner Container - visibile solo se ci sono alert -->
<div 
  class="capacity-banner-container" 
  id="capacity-banner"
  data-tipo={tipo}
  data-sheet-id={sheetId}
  data-gid={gid}
  style={capacityAlerts.length === 0 ? 'display: none;' : ''}
>
  <div class="capacity-banner">
    <div class="capacity-banner-icon">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 9V13M12 17H12.01M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>
    <div class="capacity-banner-content">
      <strong class="capacity-banner-title">
        {tipo === 'asporto' ? 'üì¶ Servizio Asporto' : tipo === 'prenotazioni' ? 'üçΩÔ∏è Prenotazioni Tavoli' : '‚ö†Ô∏è Disponibilit√† Limitata'}
      </strong>
      <p class="capacity-banner-text" id="capacity-banner-text">
        {capacityAlerts.length > 0 ? (
          capacityAlerts.length === 1 ? (
            `${tipoLabel} per ${capacityAlerts[0].giorno} ${capacityAlerts[0].data} esaurite. Altri giorni ancora disponibili.`
          ) : (
            `${tipoLabel} esaurite per: ${capacityAlerts.map(a => `${a.giorno} ${a.data}`).join(', ')}. Altri giorni ancora disponibili.`
          )
        ) : (
          'Verifica disponibilit√† in corso...'
        )}
      </p>
    </div>
    <button class="capacity-banner-close" id="capacity-banner-close" aria-label="Chiudi avviso">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
  </div>
</div>

<style>
  .capacity-banner-container {
    margin-bottom: 1.5rem;
  }

  .capacity-banner {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    padding: 1rem 1.25rem;
    background: linear-gradient(135deg, #FFF3E0 0%, #FFE0B2 100%);
    border: 1px solid #FFB74D;
    border-left: 4px solid #F4773A;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(244, 119, 58, 0.15);
  }

  .capacity-banner-icon {
    flex-shrink: 0;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #F4773A;
    border-radius: 50%;
    color: white;
  }

  .capacity-banner-content {
    flex: 1;
    min-width: 0;
  }

  .capacity-banner-title {
    display: block;
    font-size: 1rem;
    font-weight: 600;
    color: #E65100;
    margin-bottom: 0.25rem;
  }

  .capacity-banner-text {
    font-size: 0.9rem;
    color: #5D4037;
    margin: 0;
    line-height: 1.5;
  }

  .capacity-banner-close {
    flex-shrink: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: none;
    border-radius: 4px;
    color: #A1887F;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .capacity-banner-close:hover {
    background: rgba(244, 119, 58, 0.1);
    color: #F4773A;
  }

  /* Animazione entrata */
  .capacity-banner-container.animate-in .capacity-banner {
    animation: slideDown 0.3s ease-out;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Responsive */
  @media (max-width: 768px) {
    .capacity-banner {
      flex-wrap: wrap;
      padding: 1rem;
    }

    .capacity-banner-icon {
      width: 36px;
      height: 36px;
    }

    .capacity-banner-content {
      flex: 1 1 calc(100% - 100px);
    }

    .capacity-banner-title {
      font-size: 0.95rem;
    }

    .capacity-banner-text {
      font-size: 0.85rem;
    }
  }
</style>

<script define:vars={{ csvUrl, tipo }}>
  // Client-side: aggiorna i dati in tempo reale
  document.addEventListener('DOMContentLoaded', () => {
    const banner = document.getElementById('capacity-banner');
    const bannerText = document.getElementById('capacity-banner-text');
    const closeBtn = document.getElementById('capacity-banner-close');
    
    if (!banner || !bannerText) return;
    
    // Chiudi banner
    if (closeBtn) {
      closeBtn.addEventListener('click', () => {
        banner.style.display = 'none';
        // Salva in sessionStorage per non mostrarlo di nuovo nella sessione
        sessionStorage.setItem('capacity-banner-closed', 'true');
      });
    }
    
    // Se gi√† chiuso in questa sessione, non mostrare
    if (sessionStorage.getItem('capacity-banner-closed') === 'true') {
      banner.style.display = 'none';
      return;
    }
    
    // Funzione per aggiornare il banner
    async function updateBanner() {
      try {
        const response = await fetch(csvUrl);
        if (!response.ok) return;
        
        const csvText = await response.text();
        const lines = csvText.split('\n').filter(line => line.trim());
        
        if (lines.length <= 1) {
          banner.style.display = 'none';
          return;
        }
        
        const alerts = [];
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        for (let i = 1; i < lines.length; i++) {
          const values = lines[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
          const cleanValues = values.map(v => v.replace(/^"|"$/g, '').trim());
          
          if (cleanValues.length >= 8) {
            const dataStr = cleanValues[0];
            const giorno = cleanValues[1];
            const tipoRiga = cleanValues[2];
            const stato = cleanValues[6];
            const gestito = cleanValues[7]?.toUpperCase() === 'TRUE';
            
            // Parse data
            const parts = dataStr.split('/');
            if (parts.length === 3) {
              const date = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
              
              // Filtra: non gestito, FULL, data valida, tipo corretto
              if (!gestito && stato === 'üî¥ FULL' && date >= today) {
                if (tipo === 'entrambi' || 
                    (tipo === 'prenotazioni' && tipoRiga === 'Prenotazioni') ||
                    (tipo === 'asporto' && tipoRiga === 'Asporto')) {
                  alerts.push({ data: dataStr, giorno, tipo: tipoRiga });
                }
              }
            }
          }
        }
        
        // Aggiorna UI
        if (alerts.length === 0) {
          banner.style.display = 'none';
        } else {
          banner.style.display = '';
          banner.classList.add('animate-in');
          
          const tipoLabel = tipo === 'prenotazioni' ? 'Prenotazioni tavoli' : 
                           tipo === 'asporto' ? 'Ordini d\'asporto' : 
                           'Prenotazioni';
          
          if (alerts.length === 1) {
            bannerText.textContent = `${tipoLabel} per ${alerts[0].giorno} ${alerts[0].data} esaurite. Altri giorni ancora disponibili.`;
          } else {
            const dateList = alerts.map(a => `${a.giorno} ${a.data}`).join(', ');
            bannerText.textContent = `${tipoLabel} esaurite per: ${dateList}. Altri giorni ancora disponibili.`;
          }
        }
      } catch (error) {
        console.error('Errore aggiornamento banner capacit√†:', error);
      }
    }
    
    // Aggiorna subito
    updateBanner();
    
    // Aggiorna ogni 2 minuti
    setInterval(updateBanner, 2 * 60 * 1000);
  });
</script>