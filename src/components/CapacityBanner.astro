---
/**
 * CapacityBanner.astro - v3.1 (Multi-banner support)
 * 
 * Banner dinamico che mostra le date con capacit√† esaurita.
 * Usa il Web App di Google Apps Script come API (niente problemi CORS!)
 * Supporta pi√π banner nella stessa pagina (prenotazioni + asporto)
 * 
 * Props:
 * - tipo: "prenotazioni" | "asporto" | "entrambi" (default: "entrambi")
 * 
 * Environment Variables richieste in Vercel:
 * - PUBLIC_CAPACITY_API_URL: URL del Web App di Apps Script
 */

interface Props {
  tipo?: 'prenotazioni' | 'asporto' | 'entrambi';
}

const { tipo = 'entrambi' } = Astro.props;

// URL dell'API Web App
const API_URL = import.meta.env.PUBLIC_CAPACITY_API_URL || '';

// Costruisci URL completo con parametri
const fullApiUrl = API_URL ? `${API_URL}?action=capacity&tipo=${tipo}` : '';

// Interfaccia per i dati
interface CapacityAlert {
  data: string;
  giorno: string;
  tipo: string;
  soglia: number;
  attuale: number;
}

interface ApiResponse {
  alerts: CapacityAlert[];
  count: number;
  timestamp: string;
  error?: string;
}

// Variabili per il rendering
let capacityAlerts: CapacityAlert[] = [];
let apiConfigured = !!API_URL;
let fetchError = false;
let errorMessage = '';

// Fetch dati al build time (SSR)
if (apiConfigured && fullApiUrl) {
  try {
    const response = await fetch(fullApiUrl);
    if (response.ok) {
      const data: ApiResponse = await response.json();
      if (data.error) {
        fetchError = true;
        errorMessage = data.error;
      } else {
        capacityAlerts = data.alerts || [];
      }
    } else {
      fetchError = true;
      errorMessage = `HTTP ${response.status}`;
    }
  } catch (error) {
    fetchError = true;
    errorMessage = String(error);
  }
}

// Helper per il label del tipo
const getTipoLabel = (t: string) => {
  if (t === 'prenotazioni') return 'Prenotazioni tavoli';
  if (t === 'asporto') return 'Ordini d\'asporto';
  return 'Prenotazioni';
};

const tipoLabel = getTipoLabel(tipo);
---

<!-- Banner Container -->
<div 
  class="capacity-banner-container" 
  id={`capacity-banner-${tipo}`}
  data-tipo={tipo}
  data-api-url={API_URL}
  style={capacityAlerts.length === 0 ? 'display: none;' : ''}
>
  {capacityAlerts.length > 0 && (
    <div class="capacity-banner">
      <div class="capacity-banner-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 9V13M12 17H12.01M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <div class="capacity-banner-content">
        <strong class="capacity-banner-title">
          {tipo === 'asporto' ? 'üì¶ Servizio Asporto' : tipo === 'prenotazioni' ? 'üçΩÔ∏è Prenotazioni Tavoli' : '‚ö†Ô∏è Disponibilit√† Limitata'}
        </strong>
        <p class="capacity-banner-text">
          {capacityAlerts.length === 1 ? (
            `${tipoLabel} per ${capacityAlerts[0].giorno} ${capacityAlerts[0].data} esaurite. Prova a contattarci telefonicamente o tramite WhatsApp. Altri giorni ancora disponibili.`
          ) : (
            `${tipoLabel} esaurite per: ${capacityAlerts.map(a => `${a.giorno} ${a.data}`).join(', ')}. Prova a contattarci telefonicamente o tramite WhatsApp. Altri giorni ancora disponibili.`
          )}
        </p>
      </div>
      <button class="capacity-banner-close" aria-label="Chiudi avviso">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
  )}
</div>

<style>
  .capacity-banner-container {
    margin-bottom: 1.5rem;
  }

  .capacity-banner {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    padding: 1rem 1.25rem;
    background: linear-gradient(135deg, #FFF3E0 0%, #FFE0B2 100%);
    border: 1px solid #FFB74D;
    border-left: 4px solid #F4773A;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(244, 119, 58, 0.15);
  }

  .capacity-banner-icon {
    flex-shrink: 0;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #F4773A;
    border-radius: 50%;
    color: white;
  }

  .capacity-banner-content {
    flex: 1;
    min-width: 0;
  }

  .capacity-banner-title {
    display: block;
    font-size: 1rem;
    font-weight: 600;
    color: #E65100;
    margin-bottom: 0.25rem;
  }

  .capacity-banner-text {
    font-size: 0.9rem;
    color: #5D4037;
    margin: 0;
    line-height: 1.5;
  }

  .capacity-banner-close {
    flex-shrink: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: none;
    border-radius: 4px;
    color: #A1887F;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .capacity-banner-close:hover {
    background: rgba(244, 119, 58, 0.1);
    color: #F4773A;
  }

  .capacity-banner-container.animate-in .capacity-banner {
    animation: slideDown 0.3s ease-out;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @media (max-width: 768px) {
    .capacity-banner {
      flex-wrap: wrap;
      padding: 1rem;
    }

    .capacity-banner-icon {
      width: 36px;
      height: 36px;
    }

    .capacity-banner-content {
      flex: 1 1 calc(100% - 100px);
    }

    .capacity-banner-title {
      font-size: 0.95rem;
    }

    .capacity-banner-text {
      font-size: 0.85rem;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Trova tutti i banner nella pagina
    const banners = document.querySelectorAll('.capacity-banner-container');
    
    banners.forEach((banner) => {
      const bannerTitle = banner.querySelector('.capacity-banner-title');
      const bannerText = banner.querySelector('.capacity-banner-text');
      const closeBtn = banner.querySelector('.capacity-banner-close');
      
      if (!banner) return;
      
      const apiUrl = (banner as HTMLElement).dataset.apiUrl || '';
      const tipo = (banner as HTMLElement).dataset.tipo || 'entrambi';
      
      // Chiudi banner
      if (closeBtn) {
        closeBtn.addEventListener('click', () => {
          (banner as HTMLElement).style.display = 'none';
          sessionStorage.setItem(`capacity-banner-closed-${tipo}`, 'true');
        });
      }
      
      // Se gi√† chiuso in questa sessione, nascondi
      if (sessionStorage.getItem(`capacity-banner-closed-${tipo}`) === 'true') {
        (banner as HTMLElement).style.display = 'none';
        return;
      }
      
      // Se API non configurata, esci
      if (!apiUrl) {
        console.warn('CapacityBanner: PUBLIC_CAPACITY_API_URL non configurato');
        return;
      }
      
      // Funzione per aggiornare il banner (client-side refresh)
      async function updateBanner() {
        try {
          const fullUrl = `${apiUrl}?action=capacity&tipo=${tipo}&_=${Date.now()}`;
          const response = await fetch(fullUrl);
          
          if (!response.ok) {
            console.error('CapacityBanner: Errore API', response.status);
            return;
          }
          
          const data = await response.json();
          
          if (data.error) {
            console.error('CapacityBanner: API error', data.error);
            return;
          }
          
          const alerts = data.alerts || [];
          
          if (alerts.length === 0) {
            (banner as HTMLElement).style.display = 'none';
          } else {
            (banner as HTMLElement).style.display = '';
            banner.classList.add('animate-in');
            
            // Aggiorna titolo
            if (bannerTitle) {
              if (tipo === 'asporto') {
                bannerTitle.textContent = 'üì¶ Servizio Asporto';
              } else if (tipo === 'prenotazioni') {
                bannerTitle.textContent = 'üçΩÔ∏è Prenotazioni Tavoli';
              } else {
                const hasPrenotazioni = alerts.some((a: any) => a.tipo === 'Prenotazioni');
                const hasAsporto = alerts.some((a: any) => a.tipo === 'Asporto');
                
                if (hasPrenotazioni && hasAsporto) {
                  bannerTitle.textContent = '‚ö†Ô∏è Disponibilit√† Limitata';
                } else if (hasPrenotazioni) {
                  bannerTitle.textContent = 'üçΩÔ∏è Prenotazioni Tavoli';
                } else {
                  bannerTitle.textContent = 'üì¶ Servizio Asporto';
                }
              }
            }
            
            // Aggiorna testo
            if (bannerText) {
              const tipoLabel = tipo === 'prenotazioni' ? 'Prenotazioni tavoli' : 
                               tipo === 'asporto' ? 'Ordini d\'asporto' : 
                               'Prenotazioni';
              
              if (alerts.length === 1) {
                bannerText.textContent = `${tipoLabel} per ${alerts[0].giorno} ${alerts[0].data} esaurite. Prova a contattarci telefonicamente o tramite WhatsApp. Altri giorni ancora disponibili.`;
              } else {
                const dateList = alerts.map((a: any) => `${a.giorno} ${a.data}`).join(', ');
                bannerText.textContent = `${tipoLabel} esaurite per: ${dateList}. Prova a contattarci telefonicamente o tramite WhatsApp. Altri giorni ancora disponibili.`;
              }
            }
          }
        } catch (error) {
          console.error('CapacityBanner: Errore fetch', error);
        }
      }
      
      // Aggiorna subito
      updateBanner();
      
      // Aggiorna ogni 2 minuti
      setInterval(updateBanner, 2 * 60 * 1000);
    });
  });
</script>