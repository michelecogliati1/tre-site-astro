---
/**
 * Cena a Tema: Oktoberfest
 * 
 * Questa pagina fetcha tutti i dati (testi, SEO, Schema.org) da Google Sheets.
 * Per modificare i contenuti, aggiorna il foglio "CenePassate" con slug "oktoberfest".
 */

import Layout from "../../../layouts/Layout.astro";
import { 
  getCenaPassataBySlug, 
  generateCenaPassataSchemaOrg 
} from "../../../utils/googleSheets";

// ============================================
// UNICO PARAMETRO DA MODIFICARE PER OGNI CENA
// ============================================
const SLUG = "oktoberfest";

// Fetch dei dati da Google Sheets
const cena = await getCenaPassataBySlug(SLUG);

// Gestione errore se i dati non sono trovati
if (!cena) {
  console.error(`[ERRORE] Nessun dato trovato nel Google Sheet per slug: "${SLUG}"`);
}

// Destrutturazione dati (con fallback di sicurezza)
const { info, seo, images, portate } = cena || {
  info: { titolo: SLUG, data: '', ora: '', prezzo: '0' },
  seo: { 
    title: `Cena a Tema ${SLUG} | TRE`, 
    description: '', 
    canonical: `/cene-a-tema/${SLUG}/`,
    ogImage: `/img/cene-tema/${SLUG}/hero.webp`,
    preloadImage: `/img/cene-tema/${SLUG}/hero.webp`
  },
  images: { 
    heroImage: `/img/cene-tema/${SLUG}/hero.webp`, 
    ctaImage: `/img/cene-tema/${SLUG}/cta.webp` 
  },
  portate: []
};

// Genera Schema.org automaticamente dai dati del Sheet
const schemaOrg = cena ? generateCenaPassataSchemaOrg(cena) : null;
---

<Layout 
  title={seo.title}
  description={seo.description}
  canonical={seo.canonical}
  ogImage={seo.ogImage}
  preloadImage={seo.preloadImage}
>
  <!-- Schema.org JSON-LD (generato automaticamente dal Google Sheet) -->
  {schemaOrg && (
    <Fragment slot="schema">
      <script type="application/ld+json" set:html={JSON.stringify(schemaOrg)} />
    </Fragment>
  )}

  <!-- Hero Section (immagine da Google Sheet) -->
  <section 
    class="hero hero-cena-passata"
    style={`background-image: linear-gradient(rgba(0, 0, 0, 0.62), rgba(0, 0, 0, 0.62)), url('${images.heroImage}');`}
  >
    <div class="container hero-content">
      <h1>{info.titolo}</h1>
      <p class="hero-data">{info.data}, {info.ora}</p>
      <span class="hero-badge">(evento passato)</span>
      <div class="hero-buttons">
        <a href="/cene-a-tema/" class="btn btn-primary">Prossima Cena</a>
      </div>
    </div>
  </section>

  <!-- Breadcrumb -->
  <nav class="breadcrumb-nav" aria-label="Breadcrumb">
    <div class="container">
      <ol class="breadcrumb">
        <li><a href="/">Home</a></li>
        <li><a href="/cene-a-tema/">Cene a Tema</a></li>
        <li aria-current="page">{info.titolo}</li>
      </ol>
    </div>
  </nav>

  <!-- Menù della Cena Passata (portate da Google Sheet) -->
  <section class="menu-cena-passata-section">
    <div class="container">
      <div class="menu-cena-passata-header">
        <span class="menu-label">Menù della Cena Passata</span>
        <p class="menu-data">{info.data}, {info.ora}</p>
      </div>

      <div class="menu-degustazione">
        <h2 class="menu-degustazione-titolo">" {info.titolo} "</h2>

        <div class="portate-list">
          {portate.map((portata) => (
            <div class="portata-item">
              <h3 class="portata-tipo">{portata.tipo}</h3>
              {portata.piatto && (
                <>
                  <p class="portata-piatto">{portata.piatto}</p>
                  {portata.abbinamento && (
                    <p class="portata-abbinamento">{portata.abbinamento}</p>
                  )}
                </>
              )}
              <div class="portata-divider">
                <span class="dot"></span>
                <span class="dot"></span>
                <span class="dot"></span>
              </div>
            </div>
          ))}
        </div>

        <div class="menu-prezzo">
          <span class="prezzo-label">€ {info.prezzo}</span>
          <span class="prezzo-suffix">a persona</span>
        </div>
      </div>
    </div>
  </section>

  <div class="section-divider"></div>

  <!-- CTA Section (immagine da Google Sheet) -->
  <section 
    class="cta-section cta-section-cena-passata"
    style={`background-image: linear-gradient(rgba(0, 0, 0, 0.65), rgba(0, 0, 0, 0.65)), url('${images.ctaImage}');`}
  >
    <div class="container">
      <h2>Scopri la Cena in Programma</h2>
      <p>
        Consulta online il menù della prossima cena in programma e prenota il tuo tavolo
      </p>
      <a href="/cene-a-tema/" class="btn btn-primary">Prossima Cena</a>
    </div>
  </section>

  <div class="section-divider"></div>

  <!-- Sticky CTA Bottom -->
  <div class="sticky-cta-bottom" id="sticky-cta">
    <div class="sticky-cta-container">
      <div class="sticky-cta-logo">
        <img src="/img/brand/tre-logo.svg" alt="TRE" width="50" height="50" />
      </div>
      <div class="sticky-cta-content">
        <span class="sticky-cta-title">Cene a Tema</span>
        <span class="sticky-cta-subtitle">Scopri la prossima</span>
      </div>
      <a href="/cene-a-tema/" class="btn btn-primary sticky-cta-btn">Prossima Cena</a>
    </div>
  </div>
</Layout>

<style>
  /* Hero Cena Passata */
  .hero-cena-passata {
    background-size: cover;
    background-position: center;
  }

  .hero-cena-passata .hero-content {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .hero-data {
    font-size: 20px;
    color: var(--text-gray);
    margin-bottom: 0.5rem;
  }

  .hero-badge {
    display: inline-block;
    font-size: 16px;
    color: var(--text-white);
    opacity: 0.8;
    font-style: italic;
    margin-bottom: 2rem;
  }

  @media (max-width: 768px) {
    .hero-data { font-size: 18px; }
    .hero-badge { font-size: 14px; }
  }

  /* CTA Cena Passata */
  .cta-section-cena-passata {
    background-size: cover;
    background-position: center;
  }

  /* Menu Cena Passata Section */
  .menu-cena-passata-section {
    padding: 4rem 0;
    background-color: var(--bg-white);
  }

  @media (min-width: 768px) {
    .menu-cena-passata-section { padding: 5rem 0; }
  }

  .menu-cena-passata-header {
    text-align: center;
    margin-bottom: 2rem;
  }

  .menu-label {
    display: inline-block;
    font-size: 18px;
    font-weight: 500;
    color: var(--text-dark);
    opacity: 0.7;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 0.5rem;
  }

  .menu-data {
    font-size: 20px;
    font-weight: 600;
    color: var(--text-dark);
    margin: 0;
  }

  @media (max-width: 768px) {
    .menu-label { font-size: 16px; }
    .menu-data { font-size: 18px; }
  }

  /* Menu Degustazione */
  .menu-degustazione {
    max-width: 700px;
    margin: 0 auto;
    text-align: center;
  }

  .menu-degustazione-titolo {
    font-size: 48px;
    font-weight: 600;
    color: var(--primary-color);
    margin-bottom: 3rem;
    font-style: italic;
  }

  @media (max-width: 768px) {
    .menu-degustazione-titolo {
      font-size: 35px;
      margin-bottom: 2rem;
    }
  }

  .portate-list {
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  .portata-item { text-align: center; }

  .portata-tipo {
    font-size: 28px;
    font-weight: 600;
    color: var(--primary-color);
    margin-bottom: 0.75rem;
    text-decoration: underline;
    text-underline-offset: 4px;
  }

  .portata-piatto {
    font-size: 20px;
    font-weight: 500;
    color: var(--text-dark);
    margin-bottom: 0.5rem;
    line-height: 1.4;
  }

  .portata-abbinamento {
    font-size: 16px;
    font-weight: 400;
    color: var(--text-dark);
    opacity: 0.7;
    font-style: italic;
    margin-bottom: 0.75rem;
  }

  @media (max-width: 768px) {
    .portata-tipo { font-size: 24px; }
    .portata-piatto { font-size: 18px; }
    .portata-abbinamento { font-size: 14px; }
  }

  .portata-divider {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-top: 1rem;
  }

  .portata-divider .dot {
    width: 8px;
    height: 8px;
    background-color: var(--primary-color);
    border-radius: 50%;
  }

  .menu-prezzo {
    margin-top: 2.5rem;
    padding-top: 2rem;
    border-top: 2px solid var(--primary-pale);
  }

  .prezzo-label {
    display: block;
    font-size: 36px;
    font-weight: 700;
    color: var(--primary-color);
  }

  .prezzo-suffix {
    font-size: 18px;
    font-weight: 500;
    color: var(--text-dark);
    opacity: 0.7;
  }

  @media (max-width: 768px) {
    .prezzo-label { font-size: 28px; }
    .prezzo-suffix { font-size: 16px; }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const stickyCta = document.getElementById('sticky-cta');
    const heroSection = document.querySelector('.hero');
    const ctaSection = document.querySelector('.cta-section');

    if (!stickyCta || !heroSection || !ctaSection) return;

    const handleScroll = () => {
      const heroBottom = heroSection.getBoundingClientRect().bottom;
      const ctaTop = ctaSection.getBoundingClientRect().top;
      const windowHeight = window.innerHeight;
      const shouldShow = heroBottom < 0 && ctaTop > windowHeight - 100;

      stickyCta.classList.toggle('visible', shouldShow);
    };

    window.addEventListener('scroll', handleScroll);
    handleScroll();
  });
</script>