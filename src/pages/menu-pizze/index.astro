---
import Layout from "../../layouts/Layout.astro";
import { fetchSheetData, filterByCategory, formatPrice, formatAllergens, SHEET_GIDS } from "../../utils/googleSheets";

// Fetch dati da Google Sheets (avviene solo al BUILD TIME)
const allItems = await fetchSheetData(SHEET_GIDS.menuPizze);

// Raggruppa per categoria
const pizzeTradizionali = filterByCategory(allItems, 'pizze-tradizionali');
const pizzeSpeciali = filterByCategory(allItems, 'pizze-speciali');
const filoncini = filterByCategory(allItems, 'filoncini');
const pizzeVegetariane = filterByCategory(allItems, 'pizze-vegetariane');

// SEO Data
const seoData = {
  title: "Menù Pizze Artigianali | a Legna - Pizzeria TRE Merate",
  description: "Scopri il menù pizze del Ristorante TRE a Merate. Pizze artigianali in forno a legna con impasti a lunga lievitazione e ingredienti freschi.",
  canonical: "https://www.ristorantepizzeriatre.it/menu-pizze/",
  ogImage: "https://www.ristorantepizzeriatre.it/img/menu-pizze/menu-pizze-ristorante-pizzeria-tre-merate-hero.webp",
  preloadImage: "/img/menu-pizze/menu-pizze-ristorante-pizzeria-tre-merate-hero.webp",
};

// Schema.org per Menu + BreadcrumbList
const schemaOrg = {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "Menu",
      "@id": "https://www.ristorantepizzeriatre.it/menu-pizze/#menu",
      "name": "Menù Pizze - Ristorante Pizzeria TRE",
      "description": "Menù delle pizze cotte nel forno a legna con impasti a lunga lievitazione, disponibili presso il Ristorante Pizzeria TRE a Merate.",
      "url": "https://www.ristorantepizzeriatre.it/menu-pizze/",
      "mainEntityOfPage": "https://www.ristorantepizzeriatre.it/menu-pizze/",
      "inLanguage": "it-IT",
      "offers": {
        "@type": "Offer",
        "priceCurrency": "EUR"
      },
      "hasMenuSection": [
        {
          "@type": "MenuSection",
          "name": "Pizze Tradizionali",
          "description": "Pizze classiche preparate con impasto a lunga lievitazione e ingredienti freschi",
          "hasMenuItem": pizzeTradizionali.slice(0, 4).map(pizza => ({
            "@type": "MenuItem",
            "name": pizza.nome,
            "description": pizza.descrizione,
            "offers": {
              "@type": "Offer",
              "price": pizza.prezzo.replace(',', '.'),
              "priceCurrency": "EUR"
            }
          }))
        },
        {
          "@type": "MenuSection",
          "name": "Pizze Speciali",
          "description": "Pizze con ingredienti selezionati e combinazioni ricercate",
          "hasMenuItem": pizzeSpeciali.slice(0, 2).map(pizza => ({
            "@type": "MenuItem",
            "name": pizza.nome,
            "description": pizza.descrizione,
            "offers": {
              "@type": "Offer",
              "price": pizza.prezzo.replace(',', '.'),
              "priceCurrency": "EUR"
            }
          }))
        },
        {
          "@type": "MenuSection",
          "name": "I Filoncini",
          "description": "Calzoni croccanti all'esterno e soffici all'interno"
        },
        {
          "@type": "MenuSection",
          "name": "Pizze Vegetariane e Vegane",
          "description": "Pizze preparate con ingredienti genuini e naturali"
        }
      ]
    },
    {
      "@type": "BreadcrumbList",
      "@id": "https://www.ristorantepizzeriatre.it/menu-pizze/#breadcrumb",
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": "Home",
          "item": "https://www.ristorantepizzeriatre.it/"
        },
        {
          "@type": "ListItem",
          "position": 2,
          "name": "Menù Pizze",
          "item": "https://www.ristorantepizzeriatre.it/menu-pizze/"
        }
      ]
    },
    {
      "@type": "WebPage",
      "@id": "https://www.ristorantepizzeriatre.it/menu-pizze/#webpage",
      "url": "https://www.ristorantepizzeriatre.it/menu-pizze/",
      "name": "Menù Pizze | Ristorante Pizzeria TRE Merate",
      "isPartOf": {
        "@id": "https://www.ristorantepizzeriatre.it/#website"
      },
      "primaryImageOfPage": {
        "@type": "ImageObject",
        "url": "https://www.ristorantepizzeriatre.it/img/menu-pizze/menu-pizze-ristorante-pizzeria-tre-merate-hero.webp"
      },
      "breadcrumb": {
        "@id": "https://www.ristorantepizzeriatre.it/menu-pizze/#breadcrumb"
      },
      "inLanguage": "it-IT"
    }
  ]
};
---

<Layout 
  title={seoData.title}
  description={seoData.description}
  canonical={seoData.canonical}
  ogImage={seoData.ogImage}
  preloadImage={seoData.preloadImage}
>
  <!-- Schema.org JSON-LD -->
  <Fragment slot="schema">
    <script type="application/ld+json" set:html={JSON.stringify(schemaOrg)} />
  </Fragment>

  <!-- Hero Section -->
  <section class="hero hero-menu-pizze">
    <div class="container hero-content">
      <h1>Menù Pizze</h1>
      <p>
        Le nostre Pizze, cotte nel forno a legna,<br />
        preparate con ingredienti freschi e Stagionali
      </p>
      <div class="hero-buttons">
        <a href="#pizze-tradizionali" class="btn btn-primary">Scopri le Pizze</a>
        <a href="/contatti/" class="btn btn-outline">Prenota Ora</a>
      </div>
    </div>
  </section>

  <!-- Breadcrumb -->
  <nav class="breadcrumb-nav" aria-label="Breadcrumb">
    <div class="container">
      <ol class="breadcrumb">
        <li><a href="/">Home</a></li>
        <li aria-current="page">Menù Pizze</li>
      </ol>
    </div>
  </nav>

  <!-- Menu Secondario Sticky -->
  <nav class="submenu-sticky" id="submenu-sticky">
    <div class="container">
      <ul class="submenu-list">
        <li><a href="#pizze-tradizionali" class="submenu-link active">Pizze tradizionali</a></li>
        <li><a href="#pizze-speciali" class="submenu-link">Pizze speciali</a></li>
        <li><a href="#filoncini" class="submenu-link">Filoncini</a></li>
        <li><a href="#pizze-vegetariane" class="submenu-link">Pizze Vegetariane</a></li>
      </ul>
    </div>
  </nav>

  <!-- Pizze Tradizionali -->
  <section class="menu-section" id="pizze-tradizionali">
    <div class="container">
      <div class="section-header">
        <h2>Pizze Tradizionali</h2>
        <p>
          Scopri il piacere delle pizze classiche, preparate con un impasto a lunga lievitazione e
          ingredienti freschi di prima scelta, per offrirti i sapori autentici della tradizione
        </p>
      </div>

      <div class="menu-list">
        {pizzeTradizionali.map((pizza) => (
          <div class="menu-item">
            <div class="menu-item-header">
              <h3 class="menu-item-name">{pizza.nome}</h3>
              <span class="menu-item-price">{formatPrice(pizza.prezzo)}</span>
            </div>
            <p class="menu-item-desc">
              {pizza.descrizione} 
              {pizza.allergeni && <span class="allergens">{formatAllergens(pizza.allergeni)}</span>}
            </p>
          </div>
        ))}
      </div>
    </div>
  </section>

  <div class="section-divider"></div>

  <!-- Pizze Speciali -->
  <section class="menu-section" id="pizze-speciali">
    <div class="container">
      <div class="section-header">
        <h2>Pizze Speciali</h2>
        <p>
          Se desideri gustare sapori unici e ricercati, le nostre pizze speciali sono create con
          ingredienti selezionati e combinazioni sorprendenti.
        </p>
      </div>

      <div class="menu-list">
        {pizzeSpeciali.map((pizza) => (
          <div class="menu-item menu-item-special">
            <div class="menu-item-header">
              <h3 class="menu-item-name">{pizza.nome}</h3>
              <span class="menu-item-price">{formatPrice(pizza.prezzo)}</span>
            </div>
            <p class="menu-item-desc">
              {pizza.descrizione} 
              {pizza.allergeni && <span class="allergens">{formatAllergens(pizza.allergeni)}</span>}
            </p>
          </div>
        ))}
      </div>
    </div>
  </section>

  <div class="section-divider"></div>

  <!-- Filoncini -->
  <section class="menu-section" id="filoncini">
    <div class="container">
      <div class="section-header">
        <h2>I Filoncini</h2>
        <p>
          I nostri filoncini sono calzoni croccanti all'esterno e soffici all'interno,
          farciti con ingredienti di qualità per un'esperienza gustativa unica.
        </p>
      </div>

      <div class="menu-list">
        {filoncini.map((item) => (
          <div class="menu-item">
            <div class="menu-item-header">
              <h3 class="menu-item-name">{item.nome}</h3>
              <span class="menu-item-price">{formatPrice(item.prezzo)}</span>
            </div>
            <p class="menu-item-desc">
              {item.descrizione} 
              {item.allergeni && <span class="allergens">{formatAllergens(item.allergeni)}</span>}
            </p>
          </div>
        ))}
      </div>
    </div>
  </section>

  <div class="section-divider"></div>

  <!-- Pizze Vegetariane e Vegane -->
  <section class="menu-section" id="pizze-vegetariane">
    <div class="container">
      <div class="section-header">
        <h2>Pizze Vegetariane e Vegane</h2>
        <p>
          Se cerchi una variante vegetariana o vegana, offriamo una selezione di pizze preparate
          con ingredienti genuini e naturali, che rispettano il gusto senza compromessi.
        </p>
      </div>

      <div class="menu-list">
        {pizzeVegetariane.map((pizza) => (
          <div class="menu-item">
            <div class="menu-item-header">
              <h3 class="menu-item-name">{pizza.nome}</h3>
              <span class="menu-item-price">{formatPrice(pizza.prezzo)}</span>
            </div>
            <p class="menu-item-desc">
              {pizza.descrizione} 
              {pizza.allergeni && <span class="allergens">{formatAllergens(pizza.allergeni)}</span>}
            </p>
          </div>
        ))}
      </div>
    </div>
  </section>

  <div class="section-divider"></div>

  <!-- Il Segreto del Nostro Impasto -->
  <section class="feature-section">
    <div class="container">
      <div class="feature-grid">
        <div class="feature-content">
          <h2>Il Segreto del Nostro Impasto</h2>
          <p class="feature-intro">
            Ogni pizza nasce da un impasto curato con passione, lievitato naturalmente per una digeribilità unica.
          </p>
          <ul class="feature-list">
            <li>
              <span class="feature-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                  <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </span>
              <div>
                <strong>Lunga Lievitazione:</strong> 48-72 ore per un impasto leggero e digeribile
              </div>
            </li>
            <li>
              <span class="feature-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                  <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </span>
              <div>
                <strong>Farine Selezionate:</strong> miscela di farine di alta qualità
              </div>
            </li>
            <li>
              <span class="feature-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                  <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </span>
              <div>
                <strong>Lievito Madre:</strong> per un sapore autentico e una consistenza perfetta
              </div>
            </li>
          </ul>
        </div>
        <div class="feature-image">
          <img
            src="/img/menu-pizze/segreto-nostro-impasto-menu-pizze-ristorante-pizzeria-tre-merate.webp"
            alt="Il segreto del nostro impasto - Ristorante TRE Merate"
            loading="lazy"
            decoding="async"
            width="600"
            height="450"
          />
        </div>
      </div>
    </div>
  </section>

  <div class="section-divider"></div>

  <!-- Cottura nel Forno a Legna -->
  <section class="feature-section feature-section-reverse">
    <div class="container">
      <div class="feature-grid feature-grid-reverse">
        <div class="feature-image">
          <img
            src="/img/menu-pizze/cottura-forno-pizze-ristorante-pizzeria-tre-merate.webp"
            alt="Cottura nel forno a legna - Ristorante TRE Merate"
            loading="lazy"
            decoding="async"
            width="600"
            height="450"
          />
        </div>
        <div class="feature-content">
          <h2>Cottura nel Forno a Legna</h2>
          <p class="feature-intro">
            Il forno a legna è il cuore della nostra cucina, per pizze dal sapore autentico.
          </p>
          <ul class="feature-list">
            <li>
              <span class="feature-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                  <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </span>
              <div>
                <strong>Cottura Rapida:</strong> pronta in pochi minuti
              </div>
            </li>
            <li>
              <span class="feature-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                  <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </span>
              <div>
                <strong>Sapore Unico:</strong> Il legno conferisce un aroma affumicato inimitabile
              </div>
            </li>
            <li>
              <span class="feature-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                  <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </span>
              <div>
                <strong>Cottura Uniforme:</strong> fondo croccante e dorato per una cottura omogenea.
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <div class="section-divider"></div>

  <!-- Prenota il Tuo Tavolo CTA -->
  <section class="cta-section cta-section-menu-pizze">
    <div class="container">
      <h2>Prenota il Tuo Tavolo</h2>
      <p>
        Prenota comodamente online in pochi click o chiamaci per riservare il tuo tavolo
      </p>
      <a href="/contatti/" class="btn btn-primary">Prenota Ora</a>
    </div>
  </section>

  <div class="section-divider"></div>

  <!-- Sticky CTA Bottom -->
  <div class="sticky-cta-bottom" id="sticky-cta">
    <div class="sticky-cta-container">
      <div class="sticky-cta-logo">
        <img src="/img/brand/tre-logo.svg" alt="TRE" width="50" height="50" />
      </div>
      <div class="sticky-cta-content">
        <span class="sticky-cta-title">Ristorante Pizzeria TRE</span>
        <span class="sticky-cta-subtitle">Prenota il tuo tavolo</span>
      </div>
      <a href="/contatti/" class="btn btn-primary sticky-cta-btn">Prenota Ora</a>
    </div>
  </div>
</Layout>

<style>
  /* Hero Menu Pizze */
  .hero-menu-pizze {
    background-image:
      linear-gradient(rgba(0, 0, 0, 0.62), rgba(0, 0, 0, 0.62)),
      url('/img/menu-pizze/menu-pizze-ristorante-pizzeria-tre-merate-hero.webp');
  }

  /* CTA Menu Pizze */
  .cta-section-menu-pizze {
    background-image:
      linear-gradient(rgba(0, 0, 0, 0.65), rgba(0, 0, 0, 0.65)),
      url('/img/menu-pizze/ristorante-pizzeria-tre-merate-prenota-menù-pizze.webp');
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const header = document.getElementById('main-header');
    const submenu = document.getElementById('submenu-sticky');
    const submenuList = document.querySelector('.submenu-list');
    const submenuLinks = document.querySelectorAll('.submenu-link');
    const sections = document.querySelectorAll('.menu-section[id]');
    const stickyCta = document.getElementById('sticky-cta');
    const heroSection = document.querySelector('.hero');
    const ctaSection = document.querySelector('.cta-section');

    const getOffset = () => {
      const headerHeight = header ? header.offsetHeight : 0;
      const submenuHeight = submenu ? submenu.offsetHeight : 0;
      return headerHeight + submenuHeight + 40;
    };

    const scrollSubmenuToActiveLink = (activeLink) => {
      if (!submenuList || !activeLink) return;
      if (window.innerWidth > 768) return;
      const scrollLeft = activeLink.offsetLeft - 16;
      submenuList.scrollTo({ left: scrollLeft, behavior: 'smooth' });
    };

    const handleStickyCta = () => {
      if (!stickyCta || !heroSection || !ctaSection) return;
      const heroBottom = heroSection.getBoundingClientRect().bottom;
      const ctaTop = ctaSection.getBoundingClientRect().top;
      const windowHeight = window.innerHeight;
      const shouldShow = heroBottom < 0 && ctaTop > windowHeight - 100;
      if (shouldShow) {
        stickyCta.classList.add('visible');
      } else {
        stickyCta.classList.remove('visible');
      }
    };

    const highlightActiveLink = () => {
      const scrollPos = window.scrollY + getOffset() + 50;
      sections.forEach((section) => {
        const sectionTop = section.offsetTop;
        const sectionHeight = section.offsetHeight;
        const sectionId = section.getAttribute('id');
        if (scrollPos >= sectionTop && scrollPos < sectionTop + sectionHeight) {
          submenuLinks.forEach((link) => {
            const wasActive = link.classList.contains('active');
            link.classList.remove('active');
            if (link.getAttribute('href') === `#${sectionId}`) {
              link.classList.add('active');
              if (!wasActive) {
                scrollSubmenuToActiveLink(link);
              }
            }
          });
        }
      });
    };

    const onScroll = () => {
      highlightActiveLink();
      handleStickyCta();
    };

    window.addEventListener('scroll', onScroll);
    handleStickyCta();

    submenuLinks.forEach((link) => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const targetId = link.getAttribute('href');
        const targetSection = document.querySelector(targetId);
        if (targetSection) {
          const targetPosition = targetSection.offsetTop - getOffset();
          window.scrollTo({ top: targetPosition, behavior: 'smooth' });
          scrollSubmenuToActiveLink(link);
        }
      });
    });
  });
</script>